# CyberWeather 赛博朋克天气应用 - 开发计划

## 技术架构设计

### 设计思想
- **MVVM架构**：Model-View-ViewModel 分离关注点
- **多源冗余**：3个以上天气API自动切换兜底
- **响应式UI**：@Observable + SwiftUI 实现数据驱动
- **动画优先**：Canvas高性能渲染 + TimelineView 实时动画
- **赛博朋克美学**：霓虹发光、玻璃拟态、渐变立体、粒子特效

### 架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        Views Layer                          │
├──────────┬──────────┬──────────┬──────────┬────────────────┤
│ MainView │ ForecastView │ DetailView │ SettingsView │ ChartsView │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    ViewModels Layer                         │
├─────────────────┬───────────────────┬───────────────────────┤
│ WeatherViewModel │ SettingsViewModel │ LocationViewModel    │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    Services Layer                           │
├──────────┬──────────┬──────────┬──────────┬────────────────┤
│ API 1    │ API 2    │ API 3    │ Location │ Notification   │
│OpenMeteo │ wthrcdn  │ VisualCrossing │ Service │ Service       │
└─────────────────────────────────────────────────────────────┘
```

### 天气API策略（3源冗余）
| 优先级 | API | 特点 | 兜底条件 |
|--------|-----|------|----------|
| 1 | Open-Meteo | 免费无限制，支持16天预报 | 主API |
| 2 | wthrcdn.etouch.cn | 国内源，无需Key | Open-Meteo失败时 |
| 3 | Visual Crossing | 免费1000次/天，支持15天 | 前两个都失败时 |

---

## 功能模块清单

### 一、核心天气功能
- [x] 实时天气显示
- [ ] 7天天气预报（含详细数据）
- [ ] 15天天气预报
- [ ] 逐小时天气（24h详细）
- [ ] 分钟级降水预报
- [ ] 天气趋势曲线图
- [ ] 温度变化折线图
- [ ] 降水概率柱状图

### 二、生活指数
- [ ] 穿衣指数
- [ ] 紫外线指数
- [ ] 运动指数
- [ ] 洗车指数
- [ ] 舒适度指数
- [ ] 空气质量指数(AQI)
- [ ] 日出日落时间
- [ ] 月相信息
- [ ] 每日出行建议

### 三、动画系统
- [ ] 晴天动画（太阳、光芒、粒子）
- [ ] 多云动画（云层移动、层叠）
- [ ] 阴天动画（厚云、暗淡）
- [ ] 雨天动画（雨滴、涟漪、闪电）
- [ ] 雪天动画（雪花飘落）
- [ ] 雾天动画（迷雾效果）
- [ ] 夜间动画（月亮、星空）
- [ ] 霓虹粒子背景
- [ ] 扫描线效果
- [ ] 呼吸发光效果

### 四、设置功能
- [ ] 设置页面入口（右上角）
- [ ] 自动更新开关
- [ ] 更新频率设置
- [ ] 温度单位切换（℃/℉）
- [ ] 风速单位切换（km/h, m/s, mph）
- [ ] 气压单位切换（hPa, mmHg, inHg）
- [ ] 天气预警通知
- [ ] 预警时间控制
- [ ] 主题设置
- [ ] 关于页面

### 五、数据可视化
- [ ] 温度趋势曲线图
- [ ] 降水概率图表
- [ ] 风力风向图
- [ ] 湿度变化图
- [ ] 气压变化图
- [ ] AQI趋势图

---

## 文件结构（更新后）

```
CyberWeather/
├── CyberWeatherApp.swift
├── ContentView.swift
│
├── Models/
│   ├── WeatherModel.swift          # 天气数据模型（扩展）
│   ├── ForecastModel.swift         # 预报数据模型（新增）
│   ├── LifeIndexModel.swift        # 生活指数模型（新增）
│   └── SettingsModel.swift         # 设置数据模型（新增）
│
├── Services/
│   ├── WeatherService.swift        # 主API服务（重构）
│   ├── OpenMeteoService.swift      # Open-Meteo API（新增）
│   ├── WthrcdnService.swift        # wthrcdn备用API（新增）
│   ├── VisualCrossingService.swift # Visual Crossing备用API（新增）
│   ├── LocationService.swift       # 定位服务
│   └── NotificationService.swift   # 通知服务（新增）
│
├── ViewModels/
│   ├── WeatherViewModel.swift      # 天气VM（扩展）
│   └── SettingsViewModel.swift     # 设置VM（新增）
│
├── Views/
│   ├── MainWeatherView.swift       # 主页（重构）
│   ├── HourlyForecastView.swift    # 小时预报（扩展）
│   ├── DailyForecastView.swift     # 7天预报（扩展）
│   ├── Extended15DayView.swift     # 15天预报（新增）
│   ├── WeatherDetailView.swift     # 天气详情（扩展）
│   ├── LifeIndexView.swift         # 生活指数（新增）
│   ├── TravelAdviceView.swift      # 出行建议（新增）
│   ├── SettingsView.swift          # 设置页面（新增）
│   │
│   ├── Charts/                     # 图表组件（新增目录）
│   │   ├── TemperatureChartView.swift   # 温度曲线图
│   │   ├── PrecipitationChartView.swift # 降水柱状图
│   │   ├── WindChartView.swift          # 风力风向图
│   │   └── AQIChartView.swift           # 空气质量图
│   │
│   ├── Animations/                 # 天气动画（新增目录）
│   │   ├── WeatherAnimationView.swift   # 动画容器
│   │   ├── SunnyAnimation.swift         # 晴天动画
│   │   ├── CloudyAnimation.swift        # 多云动画
│   │   ├── RainyAnimation.swift         # 雨天动画
│   │   ├── SnowyAnimation.swift         # 雪天动画
│   │   ├── ThunderAnimation.swift       # 雷暴动画
│   │   ├── FoggyAnimation.swift         # 雾天动画
│   │   ├── NightAnimation.swift         # 夜间动画
│   │   └── ParticleSystem.swift         # 粒子系统
│   │
│   └── Components/
│       ├── GlowingText.swift
│       ├── GlassCard.swift
│       ├── NeonIcon.swift
│       ├── CyberBackground.swift
│       ├── ParticleView.swift
│       ├── NeonButton.swift        # 霓虹按钮（新增）
│       ├── GradientCard.swift      # 渐变卡片（新增）
│       ├── AnimatedGradient.swift  # 动画渐变（新增）
│       └── ScanlineOverlay.swift   # 扫描线叠加（新增）
│
├── Styles/
│   ├── CyberTheme.swift
│   └── CyberAnimations.swift
│
├── Extensions/
│   ├── Color+Cyber.swift
│   ├── View+Glow.swift
│   └── Date+Formatter.swift        # 日期格式化（新增）
│
└── Assets.xcassets/
```

---

## To-do List（总计：45 项）

| ID | 任务 | 预期结果 | 验证方式 | 状态 |
|----|------|---------|---------|------|
| **阶段1: API多源兜底** |
| 1 | 创建 OpenMeteoService.swift | 支持16天预报+小时数据 | API调用测试 | ✅ |
| 2 | 创建 WthrcdnService.swift | 国内备用API | API调用测试 | ✅ |
| 3 | 创建 VisualCrossingService.swift | 第三备用API | API调用测试 | ✅ |
| 4 | 重构 WeatherService.swift 实现自动切换 | 三源冗余自动兜底 | 模拟失败测试 | ✅ |
| **阶段2: 数据模型扩展** |
| 5 | 扩展 WeatherModel 支持15天 | 完整预报数据结构 | 数据解析测试 | ✅ |
| 6 | 创建 LifeIndexModel.swift | 生活指数数据模型 | 编译通过 | ✅ |
| 7 | 创建 SettingsModel.swift | 设置持久化模型 | UserDefaults测试 | ✅ |
| 8 | 创建 Date+Formatter.swift | 日期格式化扩展 | 编译通过 | ✅ |
| **阶段3: 天气动画系统** |
| 9 | 创建 WeatherAnimationView.swift | 动画容器+天气判断 | 运行查看 | ✅ |
| 10 | 创建 SunnyAnimation.swift | 太阳+光芒+粒子 | 动画流畅 | ✅ |
| 11 | 创建 CloudyAnimation.swift | 多层云移动 | 动画流畅 | ✅ |
| 12 | 创建 RainyAnimation.swift | 雨滴+涟漪 | 动画流畅 | ✅ |
| 13 | 创建 SnowyAnimation.swift | 雪花飘落 | 动画流畅 | ✅ |
| 14 | 创建 ThunderAnimation.swift | 闪电效果 | 动画流畅 | ✅ |
| 15 | 创建 FoggyAnimation.swift | 迷雾效果 | 动画流畅 | ✅ |
| 16 | 创建 NightAnimation.swift | 月亮+星空 | 动画流畅 | ✅ |
| 17 | 创建 ParticleSystem.swift | 通用粒子系统 | 复用性验证 | ✅ |
| **阶段4: UI组件增强** |
| 18 | 创建 NeonButton.swift | 霓虹发光按钮 | 视觉效果 | ✅ |
| 19 | 创建 GradientCard.swift | 渐变立体卡片 | 视觉效果 | ✅ |
| 20 | 创建 AnimatedGradient.swift | 动画渐变背景 | 动画流畅 | ✅ |
| 21 | 创建 ScanlineOverlay.swift | 赛博扫描线 | 视觉效果 | ✅ |
| **阶段5: 图表组件** |
| 22 | 创建 TemperatureChartView.swift | 温度曲线图 | 数据展示正确 | ✅ |
| 23 | 创建 PrecipitationChartView.swift | 降水柱状图 | 数据展示正确 | ✅ |
| 24 | 创建 WindChartView.swift | 风力风向图 | 数据展示正确 | ✅ |
| 25 | 创建 AQIChartView.swift | 空气质量图 | 数据展示正确 | ✅ |
| **阶段6: 主要视图重构** |
| 26 | 重构 MainWeatherView.swift | 整合动画背景 | 视觉完整 | ✅ |
| 27 | 扩展 HourlyForecastView.swift | 24h详细数据 | 数据完整 | ✅ |
| 28 | 扩展 DailyForecastView.swift | 7天详细+趋势图 | 功能完整 | ✅ |
| 29 | 创建 Extended15DayView.swift | 15天预报 | 数据展示正确 | ✅ |
| 30 | 扩展 WeatherDetailView.swift | 更多气象数据 | 数据完整 | ✅ |
| 31 | 创建 LifeIndexView.swift | 8项生活指数 | 展示正确 | ✅ |
| 32 | 创建 TravelAdviceView.swift | 每日出行建议 | 建议合理 | ✅ |
| **阶段7: 设置功能** |
| 33 | 创建 SettingsView.swift | 设置页面UI | 界面完整 | ✅ |
| 34 | 创建 SettingsViewModel.swift | 设置业务逻辑 | 持久化正常 | ✅ |
| 35 | 实现自动更新设置 | 可配置更新频率 | 功能正常 | ✅ |
| 36 | 实现单位转换 | 温度/风速/气压 | 转换正确 | ✅ |
| 37 | 创建 NotificationService.swift | 天气预警通知 | 通知送达 | ✅ |
| 38 | 实现预警时间控制 | 可设置预警时段 | 功能正常 | ✅ |
| **阶段8: 整合与优化** |
| 39 | 更新 ContentView.swift | 整合所有视图+动态背景 | 导航正常 | ✅ |
| 40 | 添加设置入口（右上角） | 齿轮图标可点击 | 跳转正常 | ✅ |
| 41 | 扩展 WeatherViewModel | 支持15天+生活指数 | 数据完整 | ✅ |
| 42 | 优化动画性能 | drawingGroup优化 | 60fps流畅 | ✅ |
| 43 | 错误处理完善 | 友好错误提示 | 体验良好 | ✅ |
| **阶段9: 测试验证** |
| 44 | 编译测试 | 无编译错误 | xcodebuild | ✅ |
| 45 | UI功能测试 | 所有功能可用 | 模拟器运行 | ✅ |

**完成标准**：所有状态必须为 ✅ 且通过验证方式
**当前进度**：45/45 (100%)

---

## Phase 2 To-do List（用户反馈修复，总计：7 项）

| ID | 任务 | 预期结果 | 验证方式 | 状态 |
|----|------|---------|---------|------|
| **阶段10: 用户反馈修复** |
| 46 | 去除背景闪烁动画 | 背景不再闪烁 | 运行查看 | ✅ |
| 47 | 移除重复的7天预报（DailyForecastView） | 只保留Extended15DayView | 运行查看 | ✅ |
| 48 | 重新布局页面 | 布局更合理美观 | 运行查看 | ✅ |
| 49 | 图表默认选中当前时间 | 图表高亮当前时间点 | 运行查看 | ✅ |
| 50 | 确保定位使用真实GPS | 显示真实定位城市 | 模拟器定位测试 | ✅ |
| 51 | 确保小时预报使用真实时间 | 显示准确当前时间 | 运行查看 | ✅ |
| 52 | 编译测试Phase2 | 无编译错误 | xcodebuild | ✅ |

**Phase 2完成标准**：所有状态必须为 ✅
**Phase 2当前进度**：7/7 (100%)

---

## Phase 3 To-do List（天气动画增强，总计：18 项）

| ID | 任务 | 预期结果 | 验证方式 | 状态 |
|----|------|---------|---------|------|
| **阶段11: 图标优化** |
| 53 | 更新App图标为琥珀水晶球风格 | 玻璃立体效果+云朵闪电 | 运行查看 | ✅ |
| **阶段12: 动画系统增强** |
| 54 | 重写 SunnyAnimation | 太阳光芒旋转+漂浮光斑+热浪 | 运行查看 | ⬜ |
| 55 | 重写 NightAnimation | 星星闪烁+流星+萤火虫+银河 | 运行查看 | ⬜ |
| 56 | 重写 RainyAnimation | 多层雨滴+涟漪+雨雾氤氲 | 运行查看 | ⬜ |
| 57 | 重写 SnowyAnimation | 旋转雪花+风向影响+多层深度 | 运行查看 | ⬜ |
| 58 | 重写 CloudyAnimation | 云层视差+边缘发光+形态变化 | 运行查看 | ⬜ |
| 59 | 重写 FoggyAnimation | 雾气流动+多层透视 | 运行查看 | ⬜ |
| 60 | 新建柔和 ThunderAnimation | 分支闪电+柔和天空闪烁 | 运行查看 | ⬜ |
| 61 | 新建 AuroraAnimation | 极光波动效果 | 运行查看 | ⬜ |
| 62 | 新建 CyberParticleSystem | 霓虹粒子+多彩效果 | 运行查看 | ⬜ |
| **阶段13: 动画集成** |
| 63 | 更新 WeatherAnimationView | 集成所有增强动画 | 运行查看 | ⬜ |
| 64 | 恢复 ContentView 动画启用 | 背景动画流畅无闪烁 | 运行查看 | ⬜ |
| 65 | 添加动画强度设置 | 可调节动画密度 | 设置页验证 | ⬜ |
| **阶段14: 性能与测试** |
| 66 | 优化动画性能 | 60fps 流畅运行 | Instruments | ⬜ |
| 67 | 测试所有天气动画 | 无崩溃无闪烁 | 模拟器测试 | ⬜ |
| 68 | 测试白天/夜晚切换 | 切换平滑自然 | 模拟器测试 | ⬜ |
| 69 | 构建Release版本 | 编译成功 | xcodebuild | ⬜ |
| 70 | 自动更新功能验证 | 30分钟自动刷新 | 运行验证 | ✅ |

**Phase 3完成标准**：所有状态必须为 ✅
**Phase 3当前进度**：2/18 (11%)

---

## 参考资源

- [Open-Meteo API](https://open-meteo.com/) - 主天气数据源
- [Apple Weather App Features](https://support.apple.com/en-us/105038)
- [天气APP产品分析](https://www.woshipm.com/pd/165399.html)
- [最佳天气API对比](https://zhuanlan.zhihu.com/p/451158509)
